{"version":3,"file":"AzureAksDetector.js","sourceRoot":"","sources":["../../../src/detectors/AzureAksDetector.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as fs from 'fs';\n\nimport { diag } from '@opentelemetry/api';\nimport { ResourceDetector, DetectedResource } from '@opentelemetry/resources';\nimport {\n  ATTR_CLOUD_PLATFORM,\n  ATTR_CLOUD_PROVIDER,\n  ATTR_K8S_CLUSTER_NAME,\n  CLOUD_PLATFORM_VALUE_AZURE_AKS,\n  CLOUD_PROVIDER_VALUE_AZURE,\n} from '../semconv';\nimport {\n  AKS_CLUSTER_RESOURCE_ID,\n  AKS_METADATA_FILE_PATH,\n  AksClusterMetadata,\n  CLOUD_RESOURCE_ID_RESOURCE_ATTRIBUTE,\n  extractClusterNameFromResourceId,\n} from '../types';\n\n/**\n * The AzureAksDetector can be used to detect if a process is running in an Azure Kubernetes Service (AKS) cluster.\n * It reads cluster metadata from environment variables populated from the aks-cluster-metadata ConfigMap\n * in the kube-public namespace, or from the ConfigMap file if mounted.\n *\n * The ConfigMap contains a single key 'clusterResourceId' with the full ARM resource ID.\n * The cluster name is extracted from this resource ID.\n *\n * @returns a {@link Resource} populated with data about the AKS environment or an empty Resource if detection fails.\n */\nclass AzureAksDetector implements ResourceDetector {\n  public detect(): DetectedResource {\n    let attributes = {};\n\n    const metadata = this.getAksMetadata();\n    if (metadata && (metadata.name || metadata.resourceId)) {\n      attributes = {\n        [ATTR_CLOUD_PROVIDER]: CLOUD_PROVIDER_VALUE_AZURE,\n        [ATTR_CLOUD_PLATFORM]: CLOUD_PLATFORM_VALUE_AZURE_AKS,\n      };\n\n      if (metadata.name) {\n        attributes = {\n          ...attributes,\n          [ATTR_K8S_CLUSTER_NAME]: metadata.name,\n        };\n      }\n\n      if (metadata.resourceId) {\n        attributes = {\n          ...attributes,\n          [CLOUD_RESOURCE_ID_RESOURCE_ATTRIBUTE]: metadata.resourceId,\n        };\n      }\n\n      diag.debug('AzureAksDetector: detected AKS cluster:', metadata);\n    }\n\n    return { attributes };\n  }\n\n  private getAksMetadata(): AksClusterMetadata | undefined {\n    // Try environment variable first (populated from aks-cluster-metadata ConfigMap)\n    const clusterResourceId = process.env[AKS_CLUSTER_RESOURCE_ID];\n\n    if (clusterResourceId) {\n      return {\n        name: extractClusterNameFromResourceId(clusterResourceId),\n        resourceId: clusterResourceId,\n      };\n    }\n\n    // Fall back to reading from mounted ConfigMap file\n    return this.getAksMetadataFromFile();\n  }\n\n  private getAksMetadataFromFile(): AksClusterMetadata | undefined {\n    try {\n      if (!fs.existsSync(AKS_METADATA_FILE_PATH)) {\n        return undefined;\n      }\n\n      const content = fs.readFileSync(AKS_METADATA_FILE_PATH, 'utf8');\n      const metadata: AksClusterMetadata = {};\n\n      // Parse the ConfigMap file content (key=value format)\n      // The native aks-cluster-metadata ConfigMap has a single key: clusterResourceId\n      const lines = content.split('\\n');\n      for (const line of lines) {\n        const trimmedLine = line.trim();\n        if (!trimmedLine || trimmedLine.startsWith('#')) {\n          continue;\n        }\n\n        const [key, ...valueParts] = trimmedLine.split('=');\n        const value = valueParts.join('=').trim();\n\n        if (key === 'clusterResourceId' && value) {\n          metadata.resourceId = value;\n          metadata.name = extractClusterNameFromResourceId(value);\n        }\n      }\n\n      if (metadata.resourceId) {\n        return metadata;\n      }\n    } catch (err: any) {\n      diag.debug(\n        'AzureAksDetector: failed to read AKS metadata file:',\n        err.message\n      );\n    }\n\n    return undefined;\n  }\n}\n\nexport const azureAksDetector = new AzureAksDetector();\n"]}